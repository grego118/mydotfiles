#!/usr/bin/env zsh


ORIGINAL_DIR=$(pwd)


# Make sure Xcode command line tools are installed
if (( ! $+commands[gcc] )); then
    echo "Xcode command line tools not installed... Run 'xcode-select --install' first."
    exit 1
fi


# Make sure the system is up to date
sudo softwareupdate --install --all --agree-to-license
sudo xcodebuild -license accept
xcodebuild -runFirstLaunch


# Make sure Homebrew is installed and up to date
(( ! $+commands[brew] )) && /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
brew update


# Keep packages up to date
brew upgrade


# Enhance Zsh
brew install zsh-completion
if ( ! compaudit ); then
    compaudit | xargs chmod g-w
fi

brew install romkatv/powerlevel10k/powerlevel10k


# Install generally useful packages
brew install findutils p7zip


# Install Git
brew install git
chmod +x ~/.gitcmds/git-*


# Install the latest Python versions
brew install openssl readline sqlite3 xz zlib pyenv

eval "$(pyenv init -)"

LATEST_PYTHON_2_VERSION=$(pyenv install --list | tr -d ' ' | grep '^2' | grep -v '[A-Za-z]\|-' | tail -1)
LATEST_PYTHON_3_VERSION=$(pyenv install --list | tr -d ' ' | grep '^3' | grep -v '[A-Za-z]\|-' | tail -1)
pyenv install $LATEST_PYTHON_2_VERSION
pyenv install $LATEST_PYTHON_3_VERSION


# Install development tools
brew install pipenv go npm cmake ripgrep
brew install --cask google-cloud-sdk
brew install --cask docker


# Setup Neovim
brew install neovim

[[ -d ~/.nvim-py2env ]] && rm -rf ~/.nvim-py2env
[[ -d ~/.nvim-py3env ]] && rm -rf ~/.nvim-py3env

export PIPENV_VENV_IN_PROJECT=true

mkdir ~/.nvim-py2env && cd $_ && pyenv local $LATEST_PYTHON_2_VERSION
pipenv install --python $(pyenv which python) neovim

mkdir ~/.nvim-py3env && cd $_ && pyenv local $LATEST_PYTHON_3_VERSION
pipenv install --python $(pyenv which python) neovim

cd $ORIGINAL_DIR

if [[ ! -f ~/.local/share/nvim/site/autoload/plug.vim ]]; then
    curl -fLo ~/.local/share/nvim/site/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    nvim -c 'PlugInstall' -c qa
else
    nvim -c 'PlugUpgrade' -c 'PlugUpdate' -c qa
fi


# Cleanup
brew cleanup
